name: Build SL3000 Firmware

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      code:
        description: "请输入验证码（必须输入 3000 才能继续构建）"
        required: true
        default: "0000"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: 验证验证码
      run: |
        if [ "${{ github.event.inputs.code }}" != "3000" ]; then
          echo "❌ 验证码错误，构建终止"
          exit 1
        fi
        echo "✅ 验证码正确，开始构建"

    - name: 释放磁盘空间（防爆盘）
      run: |
        echo "=== 清理磁盘空间 ==="
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache
        docker system prune -af || true
        sudo apt-get clean
        df -h

    - name: 恢复 ccache 缓存
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ github.ref }}-${{ github.sha }}
        restore-keys: |
          ccache-${{ github.ref }}-
          ccache-

    - name: Checkout your repo (三件套)
      uses: actions/checkout@v4
      with:
        path: yourrepo

    - name: Checkout ImmortalWrt 25.12
      uses: actions/checkout@v4
      with:
        repository: immortalwrt/immortalwrt
        ref: openwrt-25.12
        path: openwrt

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply your custom device files (三件套覆盖官方)
      run: |
        echo "=== yourrepo 目录结构 ==="
        ls -R yourrepo || true

        # 覆盖 filogic.mk
        cp yourrepo/image/filogic.mk \
           openwrt/target/linux/mediatek/image/

        # 覆盖 DTS
        mkdir -p openwrt/target/linux/mediatek/dts/
        cp yourrepo/dts/*.dts \
           openwrt/target/linux/mediatek/dts/

        # 覆盖 sl3000.config
        cp yourrepo/config/sl3000.config openwrt/.config

    - name: Verify custom device files (三件套验证)
      run: |
        cd openwrt

        echo "=== 验证 filogic.mk 是否覆盖成功 ==="
        grep -q "sl3000-emmc" target/linux/mediatek/image/filogic.mk \
          && echo "✅ filogic.mk 已覆盖" \
          || { echo "❌ filogic.mk 未覆盖"; exit 1; }

        echo "=== 验证 DTS 是否存在 ==="
        test -f target/linux/mediatek/dts/mt7981-sl3000-emmc.dts \
          && echo "✅ DTS 已覆盖" \
          || { echo "❌ DTS 未覆盖"; exit 1; }

        echo "=== 验证 .config 是否加载成功 ==="
        grep -q "CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y" .config \
          && echo "✅ .config 已加载" \
          || { echo "❌ .config 未加载"; exit 1; }

    - name: Build firmware
      run: |
        cd openwrt
        echo "CONFIG_DEVEL=y" >> .config
        echo "CONFIG_CCACHE=y" >> .config
        make defconfig
        make -j$(nproc) V=s 2>&1 | tee build.log || make -j1 V=s 2>&1 | tee build.log

    - name: 生成构建信息 build-info.txt
      run: |
        cd openwrt
        mkdir -p bin/targets/buildinfo
        echo "Device: SL3000 eMMC" > bin/targets/buildinfo/build-info.txt
        echo "Build Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> bin/targets/buildinfo/build-info.txt
        echo "Git Branch: ${{ github.ref }}" >> bin/targets/buildinfo/build-info.txt
        echo "Git Commit: ${{ github.sha }}" >> bin/targets/buildinfo/build-info.txt
        echo "OpenWrt Version: 25.12" >> bin/targets/buildinfo/build-info.txt

    - name: 保存 ccache 缓存
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ github.ref }}-${{ github.sha }}

    - name: 上传固件构建产物
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-firmware
        path: openwrt/bin/targets/

    - name: 上传构建日志（失败时）
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: openwrt/build.log

    - name: 生成 Release 说明
      run: |
        echo "## SL3000 固件构建成功" > release-notes.md
        echo "- 构建时间：$(date '+%Y-%m-%d %H:%M:%S')" >> release-notes.md
        echo "- Git Commit：${{ github.sha }}" >> release-notes.md
        echo "- 设备：SL3000 eMMC" >> release-notes.md
        echo "- 自动构建：✅" >> release-notes.md

    - name: 创建 Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: sl3000-${{ github.run_number }}
        name: SL3000 Build ${{ github.run_number }}
        body_path: release-notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 上传固件到 Release
      uses: softprops/action-gh-release@v2
      with:
        files: openwrt/bin/targets/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
