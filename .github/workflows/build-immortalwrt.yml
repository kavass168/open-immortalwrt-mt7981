name: Build ImmortalWrt SOC

on:
  workflow_dispatch:
    inputs:
      DEVICE:
        description: '➡️ 选择设备型号'
        required: true
        default: 'philips-hy3000'
        type: choice
        options:
          - 'philips-hy3000'
          - 'cetron-ct3003'
          - 'cmcc-a10'
          - 'cmcc-rax3000m-emmc'
          - 'cmcc-rax3000m-nand'
          - 'cmcc-rax3000me-nand'
          - 'umi-uax3000e'          
          - 'h3c-magic-nx30-pro'
          - 'imou-lc-hx3001'
          - 'nokia-ea0326gmp'
          - 'newland-nl-wr8103'
      SOURCE:
        default: 'immortalwrt/immortalwrt'
        required: true
        type: choice
        options:
          - VIKINGYFY/immortalwrt
          - immortalwrt/immortalwrt
          - LiBwrt/openwrt-6.x
          - qosmio/openwrt-ipq          
          
      BRANCH:
        default: 'openwrt-25.12'
        required: true
        type: choice
        options:
          - openwrt-25.12
          - openwrt-24.10
          - openwrt-23.05

env:
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  DIY_SET_SH: diy-seting.sh
  
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取你自己的仓库
      - name: Checkout Projects
        uses: actions/checkout@main
        
      - name: Initialization Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          df -h
          #sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo -E apt -yqq purge firefox
          sudo -E apt -yqq update
          sudo -E apt -yqq full-upgrade
          sudo -E apt -yqq autoremove --purge
          sudo -E apt -yqq autoclean
          sudo -E apt -yqq clean
          sudo -E apt -yqq install dos2unix libfuse-dev python3 python3-netifaces python3-pyelftools python3-setuptools libpython3-dev
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E systemctl daemon-reload
          sudo -E timedatectl set-timezone "Asia/Shanghai"
          
          sudo mkdir -p /mnt/build_wrt
          sudo chown $USER:$USER /mnt/build_wrt
          sudo ln -s /mnt/build_wrt $GITHUB_WORKSPACE/openwrt
          df -h
         
      - name: Initialization Values
        run: |
          echo "WRT_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV
          echo "WRT_KVER=none" >> $GITHUB_ENV
          echo "WRT_LIST=none" >> $GITHUB_ENV
          

      # 2. 克隆 ImmortalWrt 25.12 官方源码
      - name: Clone ImmortalWrt 25.12
        run: |
          git clone --depth=1 --single-branch --branch ${{inputs.BRANCH}} https://github.com/${{inputs.SOURCE}}.git ./openwrt/

  
      - name: Load custom feeds
        run: |
          cd ./openwrt/
          ls -l
          chmod +x $GITHUB_WORKSPACE/scripts/$DIY_P1_SH
          $GITHUB_WORKSPACE/scripts/$DIY_P1_SH

      - name: Update Feeds
        run: |
          cd ./openwrt/
          ls -l
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
      - name: Custom Packages & Custom Settings
        run: |
         ls -l
         cd ./openwrt/
         ls -l
         chmod +x $GITHUB_WORKSPACE/scripts/$DIY_P2_SH
         $GITHUB_WORKSPACE/scripts/$DIY_P2_SH
         chmod +x $GITHUB_WORKSPACE/scripts/$DIY_SET_SH
         $GITHUB_WORKSPACE/scripts/$DIY_SET_SH


      # 3. 覆盖适配文件到官方源码
      - name: Apply HY3000 device files
        run: |
          cd ./openwrt/
          chmod +x $GITHUB_WORKSPACE/scripts/copyfile-hy3000.sh
          $GITHUB_WORKSPACE/scripts/copyfile-hy3000.sh

      # 4. 运行新版检测脚本（检查 openwrt/ 目录）
      - name: Run hy3000 environment check
        run: |
          cd ./openwrt/
          chmod +x $GITHUB_WORKSPACE/scripts/check-hy3000-env.sh
          $GITHUB_WORKSPACE/scripts/check-hy3000-env.sh
          df -h
          
      - name: Download package
        id: package
        run: |
          cd ./openwrt/
          make defconfig -j$(nproc) && make clean -j$(nproc)
          make download -j$(nproc)
          

      #  编译固件
      - name: Build firmware
        id: build_step
        run: |
          cd ./openwrt/
          ls -l
          df -h
          make -j$(nproc) || make -j1 || make -j1 V=s
          

      - name: List firmware files
        run: |
          echo "=== bin 目录结构 ==="
          find openwrt/bin -maxdepth 5 -type f || true
          echo "=== mediatek/filogic 下文件 ==="
          if [ -d openwrt/bin/targets/mediatek/filogic ]; then
             ls -l openwrt/bin/targets/mediatek/filogic || true
          else
            echo "目录 openwrt/bin/targets/mediatek/filogic 不存在"
          fi


      - name: Check space usage
        run: |
          df -hT
      
      - name: Ensure firmware exists
        run: |
          if [ ! -d openwrt/bin/targets/mediatek/filogic ]; then
            echo "❌ 没有生成 mediatek/filogic 目标目录，固件未产出"
            exit 1
          fi
          COUNT=$(find openwrt/bin/targets/mediatek/filogic -type f ! -name "*.buildinfo" ! -name "*.json" | wc -l)
          if [ "$COUNT" -eq 0 ]; then
            echo "❌ mediatek/filogic 目录下没有任何固件文件"
            exit 1
          fi
          echo "✅ 找到 $COUNT 个固件相关文件"


      - name: Machine Information
        run: |
          cd ./openwrt/

          echo "======================="
          lscpu | grep -E "name|Core|Thread"
          echo "======================="
          df -h
          echo "======================="
          du -h --max-depth=1
          echo "======================="


      - name: Package Firmware
        run: |
          cd ./openwrt/ && mkdir ./upload/
          cp -f .config ./upload/Config-"$DEVICE"-"$SOURCE"-"$BRANCH"-"$WRT_DATE".txt
          echo "=== build_dir 目录结构 ==="
          ls -R ./build_dir
          echo "=== targets 目录结构 ==="
          ls -R ./bin/targets
          for FILE in $(find ./bin/targets/ -type f -iname "*$DEVICE*") ; do
             NAME=$(basename $FILE)
             NEW_FILE="$BRANCH"-"$NAME"
             mv -f $FILE ./upload/$NEW_FILE
          done


          for FILE in $(find ./bin/targets/ -type f -iname "*bl2*") ; do
             NAME=$(basename $FILE)
             NEW_FILE="$BRANCH"-"$NAME"
             mv -f $FILE ./upload/$NEW_FILE
          done

          for FILE in $(find ./bin/targets/ -type f -iname "*boot*") ; do
             NAME=$(basename $FILE)
             NEW_FILE="$BRANCH"-"$NAME"
             mv -f $FILE ./upload/$NEW_FILE
          done
          make clean -j$(nproc)          
          
      - name: Release Firmware
        uses: softprops/action-gh-release@master
        with:
          tag_name: $DEVICE-$SOURCE-$BRANCH-$WRT_DATE
          files: ./openwrt/upload/*.*
          body: |
            请注意选择你需要的设备固件！

 
